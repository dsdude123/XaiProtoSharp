# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

XaiProtoSharp is an autogenerated C# library providing a .NET wrapper for xAI's gRPC API. C# code is generated from Protocol Buffer definitions (xai-org/xai-proto) using the Buf CLI.

## Build & Test Commands

```bash
# Build the solution
dotnet build XaiProtoSharp.slnx

# Run all tests (requires XAI_API_KEY env var)
dotnet test Xai.Protos.Test

# Run a single test
dotnet test Xai.Protos.Test --filter "FullyQualifiedName~TestChat"

# Regenerate protobuf/gRPC C# code (requires Buf CLI installed)
git clone https://github.com/xai-org/xai-proto.git xai-proto
buf generate xai-proto
```

## Architecture

- **Xai.Protos** — Library project containing only auto-generated C# code from protobuf definitions. No hand-written source files. Multi-targets .NET 8.0, 9.0, and 10.0. Uses dynamic versioning based on UTC date (`yyyy.M.d`).
- **Xai.Protos.Test** — xUnit test project targeting .NET 10.0. Contains integration tests that call the live xAI API (Chat, Image, Video endpoints). Tests require the `XAI_API_KEY` environment variable set with a valid API key.

## Code Generation

`buf.gen.yaml` configures Buf to generate both protobuf message classes and gRPC service clients into the `Xai.Protos/` directory. Generated code uses the `XaiApi` namespace. The `clean: false` setting preserves the `.csproj` file during regeneration. To generate, clone `xai-org/xai-proto` and run `buf generate xai-proto` from the repo root.

## Key Dependencies

- `Google.Protobuf` — Protocol Buffers runtime
- `Grpc.Net.Client` — gRPC client (HTTP/2)
- `Google.Api.Gax.Grpc` — Google API extensions for gRPC

## Authentication Pattern

Tests authenticate with xAI API using bearer token authentication via gRPC metadata headers, reading from the `XAI_API_KEY` environment variable.

## CI/CD Workflows

### Workflows

- **check-for-updates.yml** — Runs daily at 06:00 UTC. Compares the latest `xai-org/xai-proto` commit against `.github/proto-tracking.json`. If a new commit is detected, triggers `build-and-publish.yml`.
- **build-and-publish.yml** — Main pipeline (manual trigger). Clones `xai-org/xai-proto`, replaces its `buf.gen.yaml`, generates code with Buf, builds, runs integration tests, packs and publishes NuGet packages to GitHub Packages and NuGet.org, then updates the tracking file.
- **manual-reset.yml** — Clears the `INTEGRATION_BLOCKED` flag after a pipeline failure. Requires typing "RESET" to confirm.

### Failure Flag Mechanism

When any step in the build pipeline fails (generate, build, or test), a `.github/INTEGRATION_BLOCKED` file is committed. All subsequent workflow runs check for this file and exit immediately, preventing repeated API credit burn. Use the `manual-reset.yml` workflow to clear the flag after investigating and fixing the issue.

### Required Secrets

- `XAI_API_KEY` — xAI API key for integration tests
- `NUGET_API_KEY` — NuGet.org API key for publishing
- `WORKFLOW_PAT` — Fine-grained PAT with Actions read/write permission, used by check-for-updates to trigger build-and-publish
- `GITHUB_TOKEN` — Automatically provided, used for GitHub Packages publishing

### Proto Tracking

`.github/proto-tracking.json` stores the last processed commit SHA from `xai-org/xai-proto`. Updated automatically after successful builds.
